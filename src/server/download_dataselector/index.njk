{% extends 'layouts/page.njk' %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% block content %}

<div id="download-loading-container"></div>
 





{# <a href="../hub" class="govuk-back-link">Back</a> #}




    <div class="govuk-grid-row">
  <div class="govuk-grid-column-three-quarters-from-desktop">

    <h2 class="govuk-heading-l">Download your data</h2>
    <details class="govuk-details govuk-!-margin-top-0">
  <summary class="govuk-details__summary">
    <span class="govuk-details__summary-text">
      File format and metadata
    </span>
  </summary>
  <div class="govuk-details__text">
   <h3 class="govuk-heading-s">File format</h3>
                  <p class="govuk-body">This data will download in a long format (CSV).</p>
              <p class="govuk-body">Data in a long format is stacked vertically.</p>
           <!--    <p class="govuk-body">You can use wide format when you want to interpret and analyse data.</p> -->

                 <h3 class="govuk-heading-s">Metadata</h3>
                 <p class="govuk-body">These files could contain the following metadata:</p>
                 <ul class="govuk-body govuk-list--bullet">
                  <li>name of monitoring station</li>
                  <li>site type</li>
                  <li>site ID</li>
                  <li>map coordinates</li>
                  <li>local authority</li>
                  <li>region</li>
                  <li>instrument type</li>
                  <li>inlet height</li>
                 </ul>
  </div>
</details>
                


<div class="govuk-grid-row govuk-!-margin-top-3">
  <div class="govuk-grid-column-full">
    
  <div class="govuk-!-margin-top-3">
    <h2 class="govuk-heading-m">Near real-time data from Defra</h2>
    <p class="govuk-body govuk-!-margin-bottom-5">This data is automatically measured and published every hour.</p>
<h3 class="govuk-heading-s">Automatic Urban and Rural Network (AURN)</h3>
<p class="govuk-body">The most reliable air pollution data in the UK. Provides hourly measurements of fine particulate matter (PM2.5), particulate matter (PM10), nitrogen dioxide (NO2), nitric oxide (NO), nitrogen oxides as nitrogen dioxide (NOx), ozone (O3), sulphur dioxide (SO2) and carbon monoxide (CO).</p>
   
   <div class="govuk-inset-text govuk-!-margin-top-1 govuk-!-margin-bottom-3 insettextgreen" >
      {{stationcount}} stations available
    </div>
    </div>

 {% if yearrange == 'Single' %}

    <a id="download-link" href="/download_aurn_nojs/{{ finalyear }}"  onclick="getAPIdownload('{{ finalyear }}'); return false;" role="button" class="aq-button-secondary aq-button-secondary--icon govuk-!-margin-bottom-3"
                      
                        aria-label=" Download daily average data for {{pollutant.pollutantName}}">
                
                <span class="aq-button-secondary__icon">
                    <svg focusable="false" aria-hidden="true" width="14" height="20" viewBox="0 0 14 20">
                        <path d="M1.929 9L7 14.071 12.071 9M7 14.071V1M1 18h12" fill="none" stroke="currentColor" stroke-width="2"></path>
                    </svg>
                </span>
                <span class="aq-button-secondary__text">
                    Download hourly data 
          
                        <span class="govuk-visually-hidden">
                        (Visual only)
                      </span>
                    </a>
                    {% endif %} 
                   
                    {% if yearrange == 'Multiple' %}
            <table class="govuk-table">
  <thead class="govuk-table__head">
    <tr class="govuk-table__row">
      <th scope="col" class="govuk-table__header">Year</th>
      <th scope="col" class="govuk-table__header">Hourly data</th>
    </tr>
  </thead>
  <tbody class="govuk-table__body">
    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">
        Download all years
      </th>
         <td class="govuk-table__cell">
        <a href="/emailrequest" onclick="this.href='/emailrequest?js=true'; return true;" class="govuk-link">Request Data</a>
      </td>
    </tr>
    
    {% for year in finalyear %}
    <tr class="govuk-table__row">
      <th scope="row" class="govuk-table__header">
        {{ year }}
      </th>
      <td class="govuk-table__cell">
        <a href="/emailrequest" onclick="getAPIdownload('{{ year }}'); return false;" class="govuk-link">Download hourly data</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
 {% endif %} 


                    
  </div>
</div>
 
  <div class="govuk-grid-column-full" id="download-content-container">
 
   
      
    {# <div class="govuk-inset-text govuk-!-margin-top-0">
  <h3 class="govuk-heading-s">Save your search</h3>
<p class="govuk-body">Bookmark this URL to save your selections for next time.</p>

<p class="govuk-body"><a href="/customdataset" class="govuk-link" target="_blank" rel="noopener noreferrer">https://get-air-pollution-data.defra.gov.uk/data-selector/download-data?saved=url</a></p> #}
{# <p class="govuk-body"><a href="/customdataset" class="govuk-link" target="_blank" rel="noopener noreferrer">https://get-air-pollution-data.defra.gov.uk/data-selector/download-data?saved=url</a></p> #}

</div>
</div>
      
    </div>
    
  </div>
</div>
<script>
async function getAPIdownload(year) {
    // Show loading indicator
  showLoadingIndicator('Preparing your download...');
  scrollToLoadingIndicator();
    
    try {
        // Step 1: Start download job and get jobID
        console.log(`Starting download for year: ${year}`);
        const response = await fetch(`/download_aurn/${year}`);
        
        if (!response.ok) {
            throw new Error(`Failed to start download: ${response.status}`);
        }
        
        const data = await response.json();
       // console.log('Download job started:', data);
        
        if (data.error) {
          hideLoadingIndicator();
            window.location.href = data.redirectUrl || `/problem-with-service?statusCode=${data.statusCode || 500}`;
            return;
        }
        
        const jobID = data.jobID;
        
        if (!jobID) {
            console.error('No jobID received');
            throw new Error('No job ID received from server');
        }
        
       // console.log(`Job ID: ${jobID}`);
        
        // Step 2: Poll for completion
        const startTime = Date.now();
        const maxDuration = 3 * 60 * 1000; // 3 minutes timeout
        
        function pollProgress() {
            // Check timeout
            if (Date.now() - startTime > maxDuration) {
                hideLoadingIndicator();
              //  alert('This download is taking longer than expected. Please use the email request option for large datasets.');
                window.location.href = '/emailrequest';
                return;
            }
            
            // Poll status endpoint
            fetch(`/download_aurn_status/${jobID}`)
                .then(statusResponse => {
                  //  console.log('Status response status:', statusResponse.status);
                    
                    if (!statusResponse.ok) {
                        throw new Error(`Status check failed: ${statusResponse.status}`);
                    }
                    
                    return statusResponse.json();
                })
                .then(statusData => {
                    //console.log('Status data:', statusData);
                    
                    if (statusData.error) {
                        hideLoadingIndicator();
                      window.location.href = statusData.redirectUrl || `/problem-with-service?statusCode=${statusData.statusCode || 500}`;
                        return;
                    }
                    
                    // Update progress message
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    const progress = Math.min(Math.floor((elapsed / 180) * 100), 95);
                   updateLoadingMessage(`Preparing your download... ${progress}%`);
                    
                    // Check if completed
                    if (statusData.status === 'Completed' && statusData.resultUrl) {
                       // console.log('Download ready:', statusData.resultUrl);
                       hideLoadingIndicator();
                        window.location.href = statusData.resultUrl;
                    } else {
                        // Continue polling after 2 seconds
                        setTimeout(pollProgress, 2000);
                    }
                })
                .catch(error => {
                    console.error('Polling error:', error);
                    // Retry after 2 seconds on error
                    setTimeout(pollProgress, 2000);
                });
        }
        
        // Start polling
        pollProgress();
        
    } catch (error) {
        console.error('Error fetching download:', error);
        hideLoadingIndicator();
        // Fallback to no-JS route if AJAX fails
        window.location.href = `/download_aurn_nojs/${year}`;
    }
}

function scrollToLoadingIndicator() {
  const container = document.getElementById('download-loading-container');
  const indicator = document.getElementById('download-loading');
  const target = indicator || container;
  if (target && typeof target.scrollIntoView === 'function') {
    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
  } else {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

// Helper functions for loading indicator
function showLoadingIndicator(message) {
    const indicator = document.createElement('div');
    indicator.id = 'download-loading';
    indicator.className = 'govuk-notification-banner';
    indicator.setAttribute('role', 'region');
    indicator.setAttribute('aria-labelledby', 'download-loading-title');
    indicator.innerHTML = `
        <div class="govuk-notification-banner__header">
            <h2 class="govuk-notification-banner__title" id="download-loading-title">
                Important
            </h2>
        </div>
        <div class="govuk-notification-banner__content">
            <p class="govuk-notification-banner__heading" id="download-loading-message">
                ${message}
            </p>
        </div>`;

      const container = document.getElementById('download-loading-container');
      if (container) {
        container.replaceChildren(indicator);
        return;
      }

      // Fallback: place at the top of main content
      const main = document.querySelector('main');
      if (main) {
        main.prepend(indicator);
      }
}

function updateLoadingMessage(message) {
    const messageElement = document.getElementById('download-loading-message');
    if (messageElement) {
        messageElement.textContent = message;
    }
}

function hideLoadingIndicator() {
    const indicator = document.getElementById('download-loading');
    if (indicator) {
        indicator.remove();
    }
}

document.addEventListener('DOMContentLoaded', () => {
   // console.log("DOM loaded, JavaScript download functionality ready");
});  

</script>
 {% if downloadaurnresult %}
  <script>
    //console.log("DATA FROM DOWNLOAD",downloadaurnresult)

    var downloadaurnresult1 = "{{ downloadaurnresult | safe }}";
    var url = downloadaurnresult1;
   window.location.href = url;
  </script>
   {% endif  %}
{% endblock %}

