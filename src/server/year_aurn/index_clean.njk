{% extends 'layouts/page.njk' %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    
    <!-- Server-side validation errors -->
    {% if errors.list %}
      <div class="govuk-error-summary" data-module="govuk-error-summary">
        <div role="alert">
          <h2 class="govuk-error-summary__title">There is a problem</h2>
          <div class="govuk-error-summary__body">
            <ul class="govuk-list govuk-error-summary__list">
              {% for error in errors.list %}
              <li>
                <a href="{{ error.href }}">{{ error.text }}</a>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    {% endif %}

    <form action="/year-aurn" method="post">
      <div class="govuk-form-group {% if errors.list %}govuk-form-group--error{% endif %}">
        <fieldset class="govuk-fieldset" aria-describedby="time-hint">
          <legend class="govuk-fieldset__legend govuk-fieldset__legend--l">
            <h1 class="govuk-heading-l">
              Add year(s)
            </h1>
          </legend>
           
          <div class="govuk-radios govuk-!-margin-top-0" data-module="govuk-radios">
            <!-- Year to date -->
            <div class="govuk-radios__item">
              <input class="govuk-radios__input" 
                     id="time-ytd" 
                     name="time" 
                     type="radio" 
                     value="ytd"
                     {% if selectedTime == "ytd" %}checked{% endif %}>
              <label class="govuk-label govuk-radios__label" for="time-ytd">
                Year to date (1 January to <span id="ytd-today"></span>)
              </label>
            </div>

            <!-- Any year (single year) -->
            <div class="govuk-radios__item">
              <input class="govuk-radios__input" 
                     id="time-any" 
                     name="time" 
                     type="radio" 
                     value="any" 
                     {% if selectedTime == "any" %}checked{% endif %}
                     data-aria-controls="conditional-time-any">
              <label class="govuk-label govuk-radios__label" for="time-any">
                Any year
              </label>
              <div id="time-any-hint" class="govuk-hint govuk-radios__hint">
                Choose a single whole year
              </div>
            </div>
            <div class="govuk-radios__conditional {% if selectedTime != 'any' %}govuk-radios__conditional--hidden{% endif %}" id="conditional-time-any">
              <div class="govuk-form-group" id="any-year-group">
                <label class="govuk-label" for="any-year-input">Year</label>
                <div id="any-year-hint" class="govuk-hint">For example: 2009</div>
                <input class="govuk-input govuk-input--width-4" 
                       id="any-year-input" 
                       name="any-year-input" 
                       type="text" 
                       inputmode="numeric" 
                       aria-describedby="any-year-hint"
                       value="{{ anyYear or '' }}">
              </div>
            </div>

            <!-- Range of years -->
            <div class="govuk-radios__item">
              <input class="govuk-radios__input" 
                     id="time-range" 
                     name="time" 
                     type="radio" 
                     value="range" 
                     {% if selectedTime == "range" %}checked{% endif %}
                     data-aria-controls="conditional-time-range">
              <label class="govuk-label govuk-radios__label" for="time-range">
                Range of years
              </label>
              <div id="time-range-hint" class="govuk-hint govuk-radios__hint">
                Choose up to 5 whole years at a time
              </div>
            </div>
            <div class="govuk-radios__conditional {% if selectedTime != 'range' %}govuk-radios__conditional--hidden{% endif %}" id="conditional-time-range">
              <div class="govuk-form-group" id="range-start-group">
                <label class="govuk-label" for="range-start-year">Enter start year</label>
                <div id="range-start-hint" class="govuk-hint">For example: 2009</div>
                <div class="govuk-date-input">
                  <div class="govuk-date-input__item">
                    <div class="govuk-form-group">
                      <input class="govuk-input govuk-date-input__input govuk-input--width-4" 
                             id="range-start-year" 
                             name="range-start-year" 
                             type="text" 
                             inputmode="numeric" 
                             aria-describedby="range-start-hint"
                             value="{{ rangeStart or '' }}">
                    </div>
                  </div>
                </div>
              </div>

              <div class="govuk-form-group" id="range-end-group">
                <label class="govuk-label" for="range-end-year">Enter end year</label>
                <div id="range-end-hint" class="govuk-hint">For example: 2010</div>
                <div class="govuk-date-input">
                  <div class="govuk-date-input__item">
                    <div class="govuk-form-group">
                      <input class="govuk-input govuk-date-input__input govuk-input--width-4" 
                             id="range-end-year" 
                             name="range-end-year" 
                             type="text" 
                             inputmode="numeric" 
                             aria-describedby="range-end-hint"
                             value="{{ rangeEnd or '' }}">
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </fieldset>
      </div>

      {{ govukButton({
        attributes: { id: "continuebutton" },
        text: "Continue"
      }) }}
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Set "Year to date" label with current date
  const today = new Date();
  const formatted = new Intl.DateTimeFormat('en-GB', { 
    day: 'numeric', 
    month: 'long', 
    year: 'numeric' 
  }).format(today);

  const span = document.getElementById('ytd-today');
  if (span) span.textContent = formatted;

  // Limit year inputs to 4 digits
  ['any-year-input', 'range-start-year', 'range-end-year'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', function() {
        this.value = this.value.replace(/\D/g, '').slice(0, 4);
      });
    }
  });

  // Handle form submission - let server handle all validation

});
</script>

{% endblock %}
