{% extends 'layouts/page.njk' %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% block content %}
  

{# <a href="/hubpage" class="govuk-back-link">Back</a> #}

    <div class="govuk-grid-row">
      <div class="govuk-grid-column-three-quarters-from-desktop">

      
<!-- DEFAULT to no-JS version, JavaScript will change it -->
<form action='/download_dataselectornojs' method="post" id="customdataset-form">
        <h1 class="govuk-heading-l">{{heading}}</h1>

        <p class="govuk-body govuk-!-margin-bottom-6"><a href="/customdataset/clear" id="clear-selections" class="govuk-link">{{texts.a}}</a></p>

<!-- <p class="govuk-body">Choose pollutant(s)</p> -->
 {% if error %}
     <div class="govuk-error-summary" data-module="govuk-error-summary">
  <div role="alert">
    <h2 class="govuk-error-summary__title">
      There is a problem
    </h2>
    <div class="govuk-error-summary__body">
      <p class="govuk-body">{{errormsg}}</p>
      <ul class="govuk-list govuk-error-summary__list">
      
        <li>
          <a  href="{{ errorhref1 }}">{{errorref1}}</a>
        </li>
       
        <li>
          <a  href="{{ errorhref2 }}">{{errorref2}}</a>
        </li>
      </ul>
    </div>
  </div>
</div>
    {% endif %}
    <dl class="govuk-summary-list">
        <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
     {{texts.b}}
    </dt>
   
    <dd class="govuk-summary-list__value" id="pollutant-summary-list">
     {% if selectedpollutant %}
        <ul class="govuk-list">
          {% for pollutant in selectedpollutant %}
        <li>{{ pollutant }}</li>
          {% endfor %}
        </ul>
         {% else %}
    {{texts.g}}
    {% endif %}
      
     
    </dd>
    <dd class="govuk-summary-list__actions">
       {% if selectedpollutant %}
      <a class="govuk-link" href="/airpollutant"> {{texts.n}}<span class="govuk-visually-hidden">  {{texts.l}}</span></a>
     {% else %}
 <a class="govuk-link" href="/airpollutant"> {{texts.c}}<span class="govuk-visually-hidden">  {{texts.l}}</span></a>
    
       {% endif %}

    </dd>
  </div>
   <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      {{texts.e}}
    </dt>
    <dd class="govuk-summary-list__value" id="data-source-list">
     {% if selectedpollutant %}
     <strong> {{texts.datasource}}</strong>
      {{texts.datasource1}}
      {% else %}
    {{texts.m}}
    {% endif %}
    </dd>
    {% if selectedpollutant %}
    <dd class="govuk-summary-list__actions" id="data-source-action" hidden>
        
  <a class="govuk-link" href="/datasource">View<span class="govuk-visually-hidden"> {{texts.e}}</span></a>
</dd>
 {% endif %}
  </div>
   
  
  
</dl>  

<!--     <p class="govuk-body">Choose year(s) and location(s)</p> -->

      <dl class="govuk-summary-list">
    
   
  
  
  <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      {{texts.f}}
    </dt>

    <dd class="govuk-summary-list__value" id="time-period-value">
     {% if selectedyear %}
      {{selectedyear}}
      {% else %}
    {{texts.g}}
     {% endif %}
    </dd>
      {% if selectedpollutant %}
   <dd class="govuk-summary-list__actions" id="time-period-action">
    
  <a class="govuk-link" href="/year-aurn"
  >
   {% if selectedyear %}
  {{texts.n}}
   {% else %}
    {{texts.c}}
     {% endif %}
  <span class="govuk-visually-hidden">  {{texts.h}}</span></a>

</dd>
{% endif %}
  </div>

   <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      {{texts.i}}
    </dt>
<dd class="govuk-summary-list__value" id="location-value">
  {% if selectedlocation %}
 
    <ul class="govuk-list">
    {% for location in selectedlocation %}
      <li>{{ location }}</li>
    {% endfor %}
    </ul>
  
{% else %}
  {{texts.g}}
{% endif %}
 
</dd>
 {% if selectedpollutant %}
<dd class="govuk-summary-list__actions" id="location-action">
  <a class="govuk-link" href="/location-aurn?change=true"> 
   {% if selectedlocation %}
   
      {{texts.n}}
   {% else %}
    {{texts.c}}
     {% endif %}
   
   
   <span class="govuk-visually-hidden">   {{texts.j}}</span></a>
</dd>
 {% endif %}


  </div>
 
  
</dl>

          </div>
      
        </div>

        {{ govukButton({
          text: "Continue"
        }) }}
        </form>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // =============== PROGRESSIVE ENHANCEMENT: Change form action for JS users ===============
  const form = document.getElementById('customdataset-form');
  if (form) {
    // Change to JS-enabled route when JavaScript is available
    form.action = '/download_dataselector';
    console.log('JavaScript enabled: Form action set to /download_dataselector');
  }

  // =============== 1) Read selections ===============
  // Pollutants
  const pollutantsRaw = sessionStorage.getItem('selectedPollutants');
  let pollutants = [];
  try { 
    pollutants = pollutantsRaw ? JSON.parse(pollutantsRaw) : []; 
  } catch (error) { 
    console.error('Error parsing pollutants from sessionStorage:', error);
    pollutants = []; 
  }

  const pollutantListEl = document.getElementById('pollutant-summary-list');
  const dataSourceEl = document.getElementById('data-source-list');

  if (Array.isArray(pollutants) && pollutants.length && pollutantListEl && dataSourceEl) {
    // Update pollutants display
    pollutantListEl.innerHTML = '<ul class="govuk-list">' + 
      pollutants.map(p => `<li>${p}</li>`).join('') + 
      '</ul>';

    // Change "Add" to "Change" if something is selected
    const pollutantActionCell = document.querySelector(
      '.govuk-summary-list__row:first-child .govuk-summary-list__actions a.govuk-link'
    );
    if (pollutantActionCell) {
      pollutantActionCell.innerHTML = '{{texts.n}}<span class="govuk-visually-hidden">  {{texts.l}}</span>';
    }

    // Update data source if needed
    if (typeof buildNetworksForPollutant === 'function' && typeof dsRowDivHtml === 'function') {
      const merged = [];
      const seen = new Set();
      pollutants.forEach(p => {
        buildNetworksForPollutant(p).forEach(item => {
          if (!seen.has(item)) { merged.push(item); seen.add(item); }
        });
      });
      dataSourceEl.innerHTML = merged.map(dsRowDivHtml).join('');
    }
  } else if (pollutantListEl) {
    // Make sure link says "Add" if none selected
    const pollutantActionCell = document.querySelector(
      '.govuk-summary-list__row:first-child .govuk-summary-list__actions a.govuk-link'
    );
    if (pollutantActionCell) {
      pollutantActionCell.innerHTML = '{{texts.c}}<span class="govuk-visually-hidden">  {{texts.l}}</span>';
    }
  }
});

// Helper functions (define these if they don't exist elsewhere)
function buildNetworksForPollutant(pollutant) {
  // Return array of networks/data sources for this pollutant
  return ['AURN']; // placeholder - implement your logic
}

function dsRowDivHtml(dataSource) {
  // Return HTML for data source row
  return `<div><strong>${dataSource}</strong> - Network description</div>`; // placeholder
}
</script>

<!-- Add noscript fallback to confirm no-JS behavior -->
<noscript>
  <style>
    #customdataset-form::after {
      content: " (No-JS mode)";
      font-size: 0.875rem;
      color: #626a6e;
    }
  </style>
</noscript>

{% endblock %}

