{% extends 'layouts/page.njk' %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% block content %}
  

{# <a href="/hubpage" class="govuk-back-link">Back</a> #}

    <div class="govuk-grid-row">
      <div class="govuk-grid-column-three-quarters-from-desktop">

      
<!-- DEFAULT to no-JS version, JavaScript will change it -->
<form action='/download_dataselectornojs' method="post" id="customdataset-form">
        <h1 class="govuk-heading-l">{{heading}}</h1>

        <p class="govuk-body govuk-!-margin-bottom-6"><a href="/customdataset/clear" id="clear-selections" class="govuk-link">{{texts.a}}</a></p>

<!-- <p class="govuk-body">Choose pollutant(s)</p> -->
 {% if error %}
     <div class="govuk-error-summary" data-module="govuk-error-summary">
  <div role="alert">
    <h2 class="govuk-error-summary__title">
      There is a problem
    </h2>
    <div class="govuk-error-summary__body">
      <p class="govuk-body">{{errormsg}}</p>
      <ul class="govuk-list govuk-error-summary__list">
      
        <li>
          <a  href="{{ errorhref1 }}">{{errorref1}}</a>
        </li>
       
        <li>
          <a  href="{{ errorhref2 }}">{{errorref2}}</a>
        </li>
      </ul>
    </div>
  </div>
</div>
    {% endif %}
    <dl class="govuk-summary-list">
      <div class="govuk-summary-list__row">
        <dt class="govuk-summary-list__key">
          {{texts.b}}
        </dt>

        {# Normalize once and reuse #}
        {% set list = selectedpollutant or [] %}
        {% set hasSelected = (list | length) > 0 %}

        <dd class="govuk-summary-list__value" id="pollutant-summary-list">
          {% if hasSelected %}
            <ul class="govuk-list">
              {% for pollutant in list %}
                <li>{{ pollutant }}</li>
              {% endfor %}
            </ul>
          {% else %}
            {{ texts.g }}
          {% endif %}
        </dd>

        <dd class="govuk-summary-list__actions">
          <a id="pollutant-action-link" class="govuk-link" href="/airpollutant">
            {% if hasSelected %}{{ texts.n }}{% else %}{{ texts.c }}{% endif %}
            <span class="govuk-visually-hidden"> {{ texts.l }}</span>
          </a>
        </dd>
      </div>
   <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      {{texts.e}}
    </dt>
    <dd class="govuk-summary-list__value" id="data-source-list">
     {% if selectedpollutant %}
     <strong> {{texts.datasource}}</strong>
      {{texts.datasource1}}
      {% else %}
    {{texts.m}}
    {% endif %}
    </dd>
    {% if selectedpollutant %}
    <dd class="govuk-summary-list__actions" id="data-source-action" hidden>
        
  <a class="govuk-link" href="/datasource">View<span class="govuk-visually-hidden"> {{texts.e}}</span></a>
</dd>
 {% endif %}
  </div>
   
  
  
</dl>  

<!--     <p class="govuk-body">Choose year(s) and location(s)</p> -->

      <dl class="govuk-summary-list">
    
   
  
  
  <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      {{texts.f}}
    </dt>

    <dd class="govuk-summary-list__value" id="time-period-value">
     {% if selectedyear %}
      {{selectedyear}}
      {% else %}
    {{texts.g}}
     {% endif %}
    </dd>
      {% if selectedpollutant %}
   <dd class="govuk-summary-list__actions" id="time-period-action">
    
  <a class="govuk-link" href="/year-aurn"
  >
   {% if selectedyear %}
  {{texts.n}}
   {% else %}
    {{texts.c}}
     {% endif %}
  <span class="govuk-visually-hidden">  {{texts.h}}</span></a>

</dd>
{% endif %}
  </div>

   <div class="govuk-summary-list__row">
    <dt class="govuk-summary-list__key">
      {{texts.i}}
    </dt>
<dd class="govuk-summary-list__value" id="location-value">
  {% if selectedlocation %}
 
    <ul class="govuk-list">
    {% for location in selectedlocation %}
      <li>{{ location }}</li>
    {% endfor %}
    </ul>
  
{% else %}
  {{texts.g}}
{% endif %}
 
</dd>
 {% if selectedpollutant %}
<dd class="govuk-summary-list__actions" id="location-action">
  <a class="govuk-link" href="/location-aurn?change=true"> 
   {% if selectedlocation %}
   
      {{texts.n}}
   {% else %}
    {{texts.c}}
     {% endif %}
   
   
   <span class="govuk-visually-hidden">   {{texts.j}}</span></a>
</dd>
 {% endif %}


  </div>
 
  
</dl>

          </div>
      
        </div>

        {{ govukButton({
          text: "Continue"
        }) }}
        </form>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Upgrade NO-JS action to JS route
  const form = document.getElementById('customdataset-form')
  if (form) {
    form.setAttribute('action', '/download_dataselector') // JS route
    form.setAttribute('method', 'post')                   // ensure POST
    form.dataset.enhanced = 'true'
  }

  // Source of truth = SSR list from DOM
  const listEl = document.getElementById('pollutant-summary-list')
  const actionEl = document.getElementById('pollutant-action-link')

  const serverItems = listEl
    ? Array.from(listEl.querySelectorAll('li')).map(li => li.textContent.trim()).filter(Boolean)
    : []

  const hasSSR = serverItems.length > 0

  // Always sync sessionStorage from SSR
  try {
    if (hasSSR) {
      sessionStorage.setItem('selectedPollutants', JSON.stringify(serverItems))
    } else {
      sessionStorage.removeItem('selectedPollutants')
    }
  } catch (_) {}

  // Ensure link text reflects SSR (not stale storage)
  if (actionEl) {
    actionEl.innerHTML = hasSSR
      ? '{{texts.n}}<span class="govuk-visually-hidden"> {{texts.l}}</span>'
      : '{{texts.c}}<span class="govuk-visually-hidden"> {{texts.l}}</span>'
  }
})
</script>

<!-- Add noscript fallback to confirm no-JS behavior -->
<noscript>
  <style>
    #customdataset-form::after {
      content: " (No-JS mode)";
      font-size: 0.875rem;
      color: #626a6e;
    }
  </style>
</noscript>

{% endblock %}

