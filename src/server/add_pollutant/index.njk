{% extends 'layouts/page.njk' %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}

{% block content %}
<!-- Redirect users without JavaScript to the no-JS version -->
<noscript>
  <meta http-equiv="refresh" content="0; url=/airpollutant/nojs">
</noscript>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <form action='/addpollutants' method="post">
      
      <!-- Server-side validation errors -->
      {% if errors.list %}
        <div class="govuk-error-summary" data-module="govuk-error-summary">
          <div role="alert">
            <h2 class="govuk-error-summary__title">There is a problem</h2>
            <div class="govuk-error-summary__body">
              <ul class="govuk-list govuk-error-summary__list">
                {% for error in errors.list %}
                <li>
                  <a href="{{ error.href }}">{{ error.text }}</a>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Client-side duplicate error (for UX only) -->
      <div id="duplicate-error" class="govuk-error-summary" data-module="govuk-error-summary" hidden>
        <div role="alert">
          <h2 class="govuk-error-summary__title">There is a problem</h2>
          <div class="govuk-error-summary__body">
            <ul class="govuk-list govuk-error-summary__list">
              <li><a href="#my-autocomplete">This pollutant has already been added</a></li>
            </ul>
          </div>
        </div>
      </div>

      <h1 class="govuk-heading-l">Add pollutant(s)</h1>
    
      <div class="govuk-form-group {% if errors.list and errors.list | length > 0 %}govuk-form-group--error{% endif %}">
        <fieldset class="govuk-fieldset" aria-describedby="mode-hint">
          <div id="mode-hint" class="govuk-hint">Select one option</div>

          <div class="govuk-radios" data-module="govuk-radios">
            <!-- MODE: specific -->
            <div class="govuk-radios__item">
              <input class="govuk-radios__input"
                     id="mode-specific"
                     name="pollutant-mode"
                     type="radio"
                     value="specific"
                     {% if selectedMode == "specific" %}checked{% endif %}
                     data-aria-controls="conditional-specific">
              <label class="govuk-label govuk-radios__label" for="mode-specific">
                Add pollutant(s)
              </label>
            </div>
            <div class="govuk-radios__conditional {% if selectedMode != 'specific' %}govuk-radios__conditional--hidden{% endif %}" id="conditional-specific">
              <div class="govuk-form-group">
                <div class="govuk-hint">Add up to 10 pollutants</div>

                <!-- Progressive enhancement: Autocomplete for JS, select fallback for no-JS -->
                <div id="autocomplete-container-p" class="govuk-body"></div>
                
                <!-- No-JS fallback -->
                <noscript>
                  <select class="govuk-select" id="pollutant-select" name="pollutant-select">
                    <option value="">Select a pollutant</option>
                    <option value="Fine particulate matter (PM2.5)">Fine particulate matter (PM2.5)</option>
                    <option value="Particulate matter (PM10)">Particulate matter (PM10)</option>
                    <option value="Nitrogen dioxide (NO2)">Nitrogen dioxide (NO2)</option>
                    <option value="Ozone (O3)">Ozone (O3)</option>
                    <option value="Sulphur dioxide (SO2)">Sulphur dioxide (SO2)</option>
                    <option value="Nitric oxide (NO)">Nitric oxide (NO)</option>
                    <option value="Nitrogen oxides as nitrogen dioxide (NOx as NO2)">Nitrogen oxides as nitrogen dioxide (NOx as NO2)</option>
                    <option value="Carbon monoxide (CO)">Carbon monoxide (CO)</option>
                  </select>
                </noscript>

                <div class="govuk-button-group govuk-!-margin-top-3">
                  {{ govukButton({
                    text: "Add pollutant",
                    classes: "govuk-button--secondary",
                    attributes: { id: "add-pollutant-button" }
                  }) }}
                </div>

                <!-- Dynamic pollutants table -->
                <table class="govuk-table govuk-!-margin-top-4" id="pollutant-table" {% if not selectedPollutants or selectedPollutants | length == 0 %}hidden{% endif %}>
                  <caption class="govuk-table__caption govuk-table__caption--m">Added pollutants</caption>
                  <tbody class="govuk-table__body">
                    {% if selectedPollutants and selectedPollutants | length > 0 %}
                      {% for pollutant in selectedPollutants %}
                      <tr class="govuk-table__row">
                        <th scope="row" class="govuk-table__header">Pollutant {{ loop.index }}</th>
                        <td class="govuk-table__cell">{{ pollutant }}</td>
                        <td class="govuk-table__cell">
                          <a href="#" class="govuk-link remove-pollutant">Remove</a>
                        </td>
                      </tr>
                      {% endfor %}
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- MODE: groups -->
            <div class="govuk-radios__item">
              <input class="govuk-radios__input"
                     id="mode-group"
                     name="pollutant-mode"
                     type="radio"
                     value="group"
                     {% if selectedMode == "group" %}checked{% endif %}
                     data-aria-controls="conditional-groups">
              <label class="govuk-label govuk-radios__label" for="mode-group">
                Add a group of pollutants
              </label>
            </div>

            <div class="govuk-radios__conditional {% if selectedMode != 'group' %}govuk-radios__conditional--hidden{% endif %}" id="conditional-groups">
              <div class="govuk-form-group">
                <fieldset class="govuk-fieldset" aria-describedby="pollutant-group-hint">
                  <legend class="govuk-fieldset__legend govuk-fieldset__legend--s"></legend>
                  <div id="pollutant-group-hint" class="govuk-hint">Select one option</div>

                  <div class="govuk-radios govuk-!-margin-top-3" data-module="govuk-radios">
                    <!-- Core / DAQI -->
                    <div class="govuk-radios__item">
                      <input class="govuk-radios__input" 
                             id="pg-core" 
                             name="pollutant-group" 
                             type="radio" 
                             value="core" 
                             {% if selectedGroup == "core" %}checked{% endif %}
                             aria-describedby="pg-core-hint">
                      <label class="govuk-label govuk-radios__label" for="pg-core">Daily Air Quality Index (DAQI) pollutants</label>
                      <div id="pg-core-hint" class="govuk-hint govuk-radios__hint">
                        fine particulate matter (PM2.5), particulate matter (PM10), nitrogen dioxide, ozone, sulphur dioxide
                      </div>
                    </div>

                    <!-- Compliance -->
                    <div class="govuk-radios__item">
                      <input class="govuk-radios__input" 
                             id="pg-compliance" 
                             name="pollutant-group" 
                             type="radio" 
                             value="compliance" 
                             {% if selectedGroup == "compliance" %}checked{% endif %}
                             aria-describedby="pg-compliance-hint">
                      <label class="govuk-label govuk-radios__label" for="pg-compliance">Pollutants in the Air Quality Standards Regulations 2010</label>
                      <div id="pg-compliance-hint" class="govuk-hint govuk-radios__hint">
                        fine particulate matter (PM2.5), particulate matter (PM10), nitrogen dioxide, ozone, sulphur dioxide, nitric oxide, nitrogen oxides as nitrogen dioxide, carbon monoxide
                      </div>
                    </div>
                  </div>
                </fieldset>
              </div>
            </div>
          </div>
        </fieldset>
      </div>

      <!-- Hidden input to pass selected pollutants to the server -->
      <input type="hidden" id="selectedPollutantsInput" name="selectedPollutants" value="{% if selectedPollutants %}{{ selectedPollutants | dump | safe }}{% endif %}">

      {{ govukButton({
        text: "Continue",
        classes: "govuk-!-margin-top-3",
        attributes: { id: "continue-button" }
      }) }}
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Progressive enhancement: Only initialize if JavaScript is enabled
  
  // ---- Storage helpers + keys (for session persistence)
  const KEY_SELECTED = 'selectedPollutants';
  const KEY_GROUP = 'selectedPollutantGroup';  
  const KEY_SPECIFIC = 'selectedPollutantsSpecific';

  const readJSON = (k, fb = null) => {
    try { return JSON.parse(sessionStorage.getItem(k) || JSON.stringify(fb)); } catch { return fb; }
  };
  const writeJSON = (k, v) => sessionStorage.setItem(k, JSON.stringify(v || []));

  // Initialize autocomplete for pollutant selection
  function initializeAutocomplete() {
    const container = document.querySelector('#autocomplete-container-p');
    if (container && !container.querySelector('#my-autocomplete')) {
      // Use globally available accessibleAutocomplete
      if (window.accessibleAutocomplete) {
        window.accessibleAutocomplete({
          element: container,
          id: 'my-autocomplete',
          source: [
            'Fine particulate matter (PM2.5)',
            'Particulate matter (PM10)',
            'Nitrogen dioxide (NO2)',
            'Ozone (O3)',
            'Sulphur dioxide (SO2)',
            'Nitric oxide (NO)',
            'Nitrogen oxides as nitrogen dioxide (NOx as NO2)',
            'Carbon monoxide (CO)'
          ]
        });
      }
    }
  }

  // Define allowed pollutants for client-side validation
  const allowedPollutants = [
    'Fine particulate matter (PM2.5)',
    'Particulate matter (PM10)',
    'Nitrogen dioxide (NO2)',
    'Ozone (O3)',
    'Sulphur dioxide (SO2)',
    'Nitric oxide (NO)',
    'Nitrogen oxides as nitrogen dioxide (NOx as NO2)',
    'Carbon monoxide (CO)'
  ];

  // Helper function to check if a pollutant is allowed
  const isAllowedPollutant = (value) => {
    const trimmedValue = (value || '').trim();
    return allowedPollutants.some(
      (pollutant) => pollutant.toLowerCase() === trimmedValue.toLowerCase()
    );
  };

  // Cache key elements
  const addButton = document.getElementById('add-pollutant-button');
  const continueButton = document.getElementById('continue-button');
  const table = document.getElementById('pollutant-table');
  const tableBody = table?.querySelector('tbody');

  // State for specific mode
  const addedPollutants = new Set(); // Track unique values (lowercased)

  // Helper to update add button text
  function updateAddButtonText() {
    if (!addButton) return;
    addButton.textContent = tableBody?.children.length > 0 ? 'Add another pollutant' : 'Add pollutant';
  }

  // Helper to update row numbers after removal
  function updateRowNumbers() {
    if (!tableBody) return;
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    rows.forEach((row, index) => {
      const headerCell = row.querySelector('th');
      if (headerCell) {
        headerCell.textContent = `Pollutant ${index + 1}`;
      }
    });
  }

  // Update hidden input with current pollutants for server submission
  function updateHiddenPollutantsInput(pollutants) {
    const hiddenInput = document.getElementById('selectedPollutantsInput');
    if (hiddenInput) {
      hiddenInput.value = JSON.stringify(pollutants || []);
    }
  }

  // Persist the current table rows
  function persistSpecificFromTable() {
    if (!tableBody) return;
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    const list = rows.map(r => r.querySelector('td')?.textContent?.trim()).filter(Boolean);
    writeJSON(KEY_SPECIFIC, list);
    updateHiddenPollutantsInput(list);
  }

  // Add new pollutant (client-side for UX, server validates)
  if (addButton) {
    addButton.addEventListener('click', function (e) {
      e.preventDefault();

      const input = document.querySelector('#my-autocomplete');
      if (!input) return;

      const value = (input.value || '').trim();
      
      // Check if no pollutant is entered
      if (!value) {
        // Show error for empty input
        const errorSummary = document.getElementById('duplicate-error');
        if (errorSummary) {
          // Update error message for empty input
          const errorLink = errorSummary.querySelector('a');
          if (errorLink) {
            errorLink.textContent = 'Please add a pollutant';
          }
          errorSummary.hidden = false;
          errorSummary.focus();
        }
        return;
      }

      // Check if pollutant is in the allowed list
      if (!isAllowedPollutant(value)) {
        // Show error for invalid pollutant
        const errorSummary = document.getElementById('duplicate-error');
        if (errorSummary) {
          // Update error message for invalid pollutant
          const errorLink = errorSummary.querySelector('a');
          if (errorLink) {
            errorLink.textContent = 'Please select a pollutant from the allowed list';
          }
          errorSummary.hidden = false;
          errorSummary.focus();
        }
        return;
      }

      const lowerValue = value.toLowerCase();
      
      // Check for duplicates in UI
      if (addedPollutants.has(lowerValue)) {
        const errorSummary = document.getElementById('duplicate-error');
        if (errorSummary) {
          // Reset error message to duplicate message
          const errorLink = errorSummary.querySelector('a');
          if (errorLink) {
            errorLink.textContent = 'This pollutant has already been added';
          }
          errorSummary.hidden = false;
          errorSummary.focus();
        }
        return;
      }

      // Hide duplicate error if showing
      const errorSummary = document.getElementById('duplicate-error');
      if (errorSummary) errorSummary.hidden = true;

      // Add to UI table
      addedPollutants.add(lowerValue);

      if (table) {
        table.hidden = false;
        
        const row = document.createElement('tr');
        row.className = 'govuk-table__row';

        const headerCell = document.createElement('th');
        headerCell.scope = 'row';
        headerCell.className = 'govuk-table__header';
        headerCell.textContent = `Pollutant ${(tableBody?.children.length || 0) + 1}`;

        const valueCell = document.createElement('td');
        valueCell.className = 'govuk-table__cell';
        valueCell.textContent = value;

        const actionCell = document.createElement('td');
        actionCell.className = 'govuk-table__cell';

        const removeLink = document.createElement('a');
        removeLink.href = '#';
        removeLink.className = 'govuk-link remove-pollutant';
        removeLink.textContent = 'Remove';

        removeLink.addEventListener('click', function (e) {
          e.preventDefault();
          row.remove();
          addedPollutants.delete(lowerValue);
          updateRowNumbers();
          persistSpecificFromTable();

          if (tableBody?.children.length === 0) {
            table.hidden = true;
          }
          updateAddButtonText();
        });

        actionCell.appendChild(removeLink);
        row.appendChild(headerCell);
        row.appendChild(valueCell);
        row.appendChild(actionCell);
        
        if (tableBody) {
          tableBody.appendChild(row);
        }

        input.value = '';
        persistSpecificFromTable();
        updateAddButtonText();
      }
    });
  }

  // Handle continue button - just submit the form, server handles validation
  if (continueButton) {
    continueButton.addEventListener('click', function (e) {
      e.preventDefault();
      
      const selectedMode = document.querySelector('input[name="pollutant-mode"]:checked')?.value;
      
      // Update hidden input with current pollutants before submission
      if (selectedMode === 'specific') {
        let currentPollutants = [];
        if (table && !table.hidden && tableBody && tableBody.children.length > 0) {
          const rows = tableBody.querySelectorAll('tr');
          rows.forEach(row => {
            const name = row.querySelector('td')?.textContent?.trim();
            if (name) currentPollutants.push(name);
          });
        }
        updateHiddenPollutantsInput(currentPollutants);
      }
      
      // Submit form to server for validation
      const form = document.querySelector('form[action="/addpollutants"]');
      if (form) {
        form.submit();
      }
    });
  }

  // Initialize remove links for server-rendered pollutants
  document.querySelectorAll('.remove-pollutant').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const row = this.closest('tr');
      const pollutantName = row.querySelector('td')?.textContent?.trim();
      
      if (row && pollutantName) {
        row.remove();
        addedPollutants.delete(pollutantName.toLowerCase());
        updateRowNumbers();
        persistSpecificFromTable();

        if (tableBody?.children.length === 0) {
          table.hidden = true;
        }
        updateAddButtonText();
      }
    });
  });

  // Initialize state from server-rendered pollutants
  if (tableBody) {
    const rows = tableBody.querySelectorAll('tr');
    rows.forEach(row => {
      const pollutantName = row.querySelector('td')?.textContent?.trim();
      if (pollutantName) {
        addedPollutants.add(pollutantName.toLowerCase());
      }
    });
  }

  updateAddButtonText();

  // Handle radio button changes to show/hide conditionals and initialize autocomplete
  const modeRadios = document.querySelectorAll('input[name="pollutant-mode"]');
  modeRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      if (this.value === 'specific' && this.checked) {
        // Small delay to ensure the conditional is shown before initializing autocomplete
        setTimeout(() => {
          initializeAutocomplete();
        }, 100);
      }
    });
  });

  // Initialize autocomplete if specific mode is already selected (e.g., on form errors)
  const selectedMode = document.querySelector('input[name="pollutant-mode"]:checked');
  if (selectedMode && selectedMode.value === 'specific') {
    // Small delay to ensure DOM is ready
    setTimeout(() => {
      initializeAutocomplete();
    }, 100);
  }
});
</script>

{% endblock %}
