{% extends 'layouts/page.njk' %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% block content %}
 


<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">

    <!-- duplicate error (specific pollutants flow) -->
    <div id="duplicate-error" class="govuk-error-summary" data-module="govuk-error-summary" hidden>
      <div role="alert">
        <h2 class="govuk-error-summary__title">There is a problem</h2>
        <div class="govuk-error-summary__body">
          <ul class="govuk-list govuk-error-summary__list">
            <li><a href="#my-autocomplete">This pollutant has already been added</a></li>
          </ul>
        </div>
      </div>
    </div>

      {% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
 {% if errors.list %}
     <div class="govuk-error-summary" data-module="govuk-error-summary">
  <div role="alert">
    <h2 class="govuk-error-summary__title">
      There is a problem
    </h2>
    <div class="govuk-error-summary__body">
      <ul class="govuk-list govuk-error-summary__list">
        <li>
          <a href="#search-input">{{errorMessage.message.text}}</a>
        </li>
      </ul>
    </div>
  </div>
</div>
  {% endif %}
{% if errorMessage.message %}
  <div class="govuk-form-group govuk-form-group--error">
    <p id="event-name-error" class="govuk-error-message">
      <span class="govuk-visually-hidden">Error:</span> {{ errorMessage.message.text }}
    </p>

   
  

    <h1 class="govuk-heading-l">Add pollutant(s)</h1>
    

    <div class="govuk-form-group">
      <fieldset class="govuk-fieldset" aria-describedby="mode-hint">
        <!-- <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
          Choose how youâ€™d like to add pollutants
        </legend> -->
        <div id="mode-hint" class="govuk-hint">Select one option</div>

        <div class="govuk-radios" data-module="govuk-radios">
          <!-- MODE: specific -->
          <div class="govuk-radios__item">
            <input class="govuk-radios__input"
                   id="mode-specific"
                   name="pollutant-mode"
                   type="radio"
                   value="specific"
                   data-aria-controls="conditional-specific">
            <label class="govuk-label govuk-radios__label" for="mode-specific">
              Add pollutant(s)
            </label>
          </div>
          <div class="govuk-radios__conditional govuk-radios__conditional--hidden" id="conditional-specific">
            <div class="govuk-form-group">
              <div class="govuk-hint">Add up to 10 pollutants</div>

              <!-- Autocomplete target + input -->
              <div id="autocomplete-container-p" class="govuk-body"></div>

              <div class="govuk-button-group govuk-!-margin-top-3">
                {{ govukButton({
                  text: "Add pollutant",
                  classes: "govuk-button--secondary",
                  attributes: { id: "add-pollutant-button" }
                }) }}
              </div>

              <table class="govuk-table govuk-!-margin-top-4" id="pollutant-table" hidden>
                <caption class="govuk-table__caption govuk-table__caption--m">Added pollutants</caption>
                <tbody class="govuk-table__body"></tbody>
              </table>
            </div>
          </div>
          </div>

        <!-- MODE: groups -->

{% else %}
<h1 class="govuk-heading-l">Add pollutant(s)</h1>
    

    <div class="govuk-form-group">
      <fieldset class="govuk-fieldset" aria-describedby="mode-hint">
        <!-- <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
          Choose how youâ€™d like to add pollutants
        </legend> -->
        <div id="mode-hint" class="govuk-hint">Select one option</div>

        <div class="govuk-radios" data-module="govuk-radios">
          <!-- MODE: specific -->
          <div class="govuk-radios__item">
            <input class="govuk-radios__input"
                   id="mode-specific"
                   name="pollutant-mode"
                   type="radio"
                   value="specific"
                   data-aria-controls="conditional-specific">
            <label class="govuk-label govuk-radios__label" for="mode-specific">
              Add pollutant(s)
            </label>
          </div>
          <div class="govuk-radios__conditional govuk-radios__conditional--hidden" id="conditional-specific">
            <div class="govuk-form-group">
              <div class="govuk-hint">Add up to 10 pollutants</div>

              <!-- Autocomplete target + input -->
              <div id="autocomplete-container-p" class="govuk-body"></div>

              <div class="govuk-button-group govuk-!-margin-top-3">
                {{ govukButton({
                  text: "Add pollutant",
                  classes: "govuk-button--secondary",
                  attributes: { id: "add-pollutant-button" }
                }) }}
              </div>

              <table class="govuk-table govuk-!-margin-top-4" id="pollutant-table" hidden>
                <caption class="govuk-table__caption govuk-table__caption--m">Added pollutants</caption>
                <tbody class="govuk-table__body"></tbody>
              </table>
            </div>
          </div>
          {% endif %}



<div class="govuk-radios__item">
  <input class="govuk-radios__input"
         id="mode-group"
         name="pollutant-mode"
         type="radio"
         value="group"
         data-aria-controls="conditional-groups">
  <label class="govuk-label govuk-radios__label" for="mode-group">
    Add a group of pollutants
  </label>
</div>

<div class="govuk-radios__conditional govuk-radios__conditional--hidden" id="conditional-groups">
  <div class="govuk-form-group">
    <fieldset class="govuk-fieldset" aria-describedby="pollutant-group-hint">
      <legend class="govuk-fieldset__legend govuk-fieldset__legend--s"></legend>
      <div id="pollutant-group-hint" class="govuk-hint">Select one option</div>

      <div class="govuk-radios govuk-!-margin-top-3" data-module="govuk-radios">
       

        <!-- Core / DAQI -->
        <div class="govuk-radios__item">
          <input class="govuk-radios__input" id="pg-core" name="pollutant-group" type="radio" value="core" aria-describedby="pg-core-hint">
          <label class="govuk-label govuk-radios__label" for="pg-core">Daily Air Quality Index (DAQI) pollutants</label>
          <div id="pg-core-hint" class="govuk-hint govuk-radios__hint">
            fine particulate matter (PM2.5), particulate matter (PM10), nitrogen dioxide, ozone, sulphur dioxide
          </div>
        </div>

         <!-- Compliance (new) -->
        <div class="govuk-radios__item">
          <input class="govuk-radios__input" id="pg-compliance" name="pollutant-group" type="radio" value="compliance" aria-describedby="pg-compliance-hint">
          <label class="govuk-label govuk-radios__label" for="pg-compliance">Pollutants in the Air Quality Standards Regulations 2010</label>
          <div id="pg-compliance-hint" class="govuk-hint govuk-radios__hint">
            fine particulate matter (PM2.5), particulate matter (PM10), nitrogen dioxide, ozone, sulphur dioxide, nitric oxide, nitrogen oxides as nitrogen dioxide, carbon monoxide
          </div>
        </div>

        
      </div>
    </fieldset>
  </div>
</div>



    {{ govukButton({
      text: "Continue",
      classes: "govuk-!-margin-top-3",
      attributes: { id: "continue-button" }
    }) }}

  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // ---- storage helpers + keys
  const KEY_SELECTED = 'selectedPollutants';           // full list used everywhere downstream
  const KEY_GROUP    = 'selectedPollutantGroup';       // which group (if any) was last chosen
  const KEY_SPECIFIC = 'selectedPollutantsSpecific';   // NEW: table-only list for "Add pollutant(s)" mode

  const readJSON = (k, fb = null) => {
    try { return JSON.parse(sessionStorage.getItem(k) || JSON.stringify(fb)); } catch { return fb; }
  };
  const writeJSON = (k, v) => sessionStorage.setItem(k, JSON.stringify(v || []));

// ----- Group definitions (used by group mode) â€” normal capitalisation
const GROUPS = {
  core: [
    'Particulate matter (PM2.5)', 'Particulate matter (PM10)',
    'Nitrogen dioxide', 'Ozone', 'Sulphur dioxide'
  ],

  // Compliance = DAQI/core plus these three
  compliance: [],

  
};

// Derive compliance from core + extra three; ensure unique list
GROUPS.compliance = Array.from(new Set([
  ...GROUPS.core,
  'Nitric oxide',
  'Nitrogen oxides as nitrogen dioxide',
  'Carbon monoxide'
]));



  // ----- Cache key elements
  const addButton = document.getElementById('add-pollutant-button');
  const continueButton = document.getElementById('continue-button');
  const table = document.getElementById('pollutant-table');
  const tableBody = table.querySelector('tbody');

  // ----- State for specific mode
  let count = 0;
  const addedPollutants = new Set(); // Track unique values (lowercased)

  // ðŸ” Helper to update add button text
  function updateAddButtonText() {
    if (!addButton) return;
    addButton.textContent = tableBody.children.length > 0 ? 'Add another pollutant' : 'Add pollutant';
  }

  // ðŸ” Helper to update row numbers after removal
  function updateRowNumbers() {
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    rows.forEach((row, index) => {
      const headerCell = row.querySelector('th');
      if (headerCell) {
        headerCell.textContent = `Pollutant ${index + 1}`;
      }
    });
  }

  // ðŸ” Persist the current table rows into the table-only list
  function persistSpecificFromTable() {
    const rows = Array.from(tableBody.querySelectorAll('tr'));
    const list = rows.map(r => r.querySelector('td')?.textContent?.trim()).filter(Boolean);
    writeJSON(KEY_SPECIFIC, list);
  }

  // 1) Restore any previously stored pollutants (specific mode)
  (function restoreFromSession() {
    const hasGroup = !!sessionStorage.getItem(KEY_GROUP);

    // If a group exists, restore the table only from the "specific" list (which may be empty),
    // otherwise fall back to the full selected list.
    let pollutants = hasGroup
      ? readJSON(KEY_SPECIFIC, [])
      : readJSON(KEY_SELECTED, []);

    if (!Array.isArray(pollutants) || pollutants.length === 0) { updateAddButtonText(); return; }

    pollutants.forEach((value) => {
      count++;
      addedPollutants.add((value || '').toLowerCase());

      const row = document.createElement('tr');
      row.className = 'govuk-table__row';

      const headerCell = document.createElement('th');
      headerCell.scope = 'row';
      headerCell.className = 'govuk-table__header';
      headerCell.textContent = `Pollutant ${count}`;

      const valueCell = document.createElement('td');
      valueCell.className = 'govuk-table__cell';
      valueCell.textContent = value;

      const actionCell = document.createElement('td');
      actionCell.className = 'govuk-table__cell';

      const removeLink = document.createElement('a');
      removeLink.href = '#';
      removeLink.className = 'govuk-link';
      removeLink.textContent = 'Remove';

      removeLink.addEventListener('click', function (e) {
        e.preventDefault();
        row.remove();
        addedPollutants.delete((value || '').toLowerCase());

        // Update row numbers after removal
        updateRowNumbers();

        // Persist updated table-only list
        persistSpecificFromTable();

        if (tableBody.children.length === 0) {
          table.hidden = true;
          count = 0;
        }
        updateAddButtonText();
      });

      actionCell.appendChild(removeLink);
      row.appendChild(headerCell);
      row.appendChild(valueCell);
      row.appendChild(actionCell);
      tableBody.appendChild(row);

      table.hidden = false;
    });

    updateAddButtonText();
  })();
function showInlineError(message, opts = {}) {
    const container =
      (opts.containerSelector && document.querySelector(opts.containerSelector)) ||
      (document.getElementById('pollutant-form-group') ||
       document.querySelector('#conditional-specific .govuk-form-group'));
    if (!container) return;

    container.classList.add('govuk-form-group--error');

    let err = container.querySelector('.govuk-error-message[data-for="dynamic"]');
    if (!err) {
      err = document.createElement('p');
      err.className = 'govuk-error-message';
      err.setAttribute('data-for', 'dynamic');
      err.id = (opts.errorId || 'pollutant-error');
      const before = container.querySelector('#autocomplete-container-p') || container.firstChild;
      container.insertBefore(err, before);
    }
    err.innerHTML = `<span class="govuk-visually-hidden">Error:</span> ${message}`;

    if (opts.inputSelector) {
      markInvalid(document.querySelector(opts.inputSelector), err.id);
    }
  }
function ensureErrorSummaryRoot() {
  console.log("comes to ensureErrorSummaryRoot")
  let root = document.getElementById('page-error-summary');
  if (!root) {
    root = document.createElement('div');
    root.id = 'page-error-summary';
    const h1 = document.querySelector('.govuk-heading-l');
    if (h1 && h1.parentNode) {
      h1.parentNode.insertBefore(root, h1); // insert ABOVE the H1
    } else {
      document.body.insertBefore(root, document.body.firstChild);
    }
  }
  return root;
}
function clearInlineError(opts = {}) {
    const containers = [];
    if (opts.containerSelector) containers.push(document.querySelector(opts.containerSelector));
    else containers.push(
      document.getElementById('pollutant-form-group') ||
      document.querySelector('#conditional-specific .govuk-form-group')
    );

    containers.filter(Boolean).forEach(container => {
      container.classList.remove('govuk-form-group--error');
      const err = container.querySelector('.govuk-error-message[data-for="dynamic"]');
      const errId = err?.id;
      if (err) err.remove();

      if (opts.inputSelector && errId) {
        clearInvalid(document.querySelector(opts.inputSelector), errId);
      }
    });
  }
   function clearInvalid(input, errId) {
    if (!input) return;
    input.removeAttribute('aria-invalid');
    const described = (input.getAttribute('aria-describedby') || '').split(/\s+/).filter(Boolean);
    const pruned = described.filter(x => x !== errId);
    if (pruned.length) input.setAttribute('aria-describedby', pruned.join(' '));
    else input.removeAttribute('aria-describedby');
  }
 function markInvalid(input, errId) {
    if (!input) return;
    input.setAttribute('aria-invalid', 'true');
    const described = (input.getAttribute('aria-describedby') || '').split(/\s+/).filter(Boolean);
    if (!described.includes(errId)) input.setAttribute('aria-describedby', [...described, errId].join(' '));
  }
  function showErrorSummary(items) {
    console.log("comes to error summary")
    // items: [{ text: 'message', href: '#fieldId' }]
    const root = ensureErrorSummaryRoot();
    root.innerHTML = `
      <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" data-module="govuk-error-summary" tabindex="-1">
        <h2 class="govuk-error-summary__title" id="error-summary-title">There is a problem</h2>
        <div class="govuk-error-summary__body">
          <ul class="govuk-list govuk-error-summary__list">
            ${items.map(i => `<li><a href="${i.href}">${i.text}</a></li>`).join('')}
          </ul>
        </div>
      </div>`;
    const summary = root.querySelector('.govuk-error-summary');
    summary?.focus?.();
  }

  function clearErrorSummary() {
    const root = document.getElementById('page-error-summary');
    if (root) root.innerHTML = '';
  }

  // Helper function to check if a pollutant is allowed
  function isAllowed(value) {
    // Define allowed pollutants (should match your autocomplete source)
    const allowedPollutants = [
      'Fine particulate matter (PM2.5)',
      'Particulate matter (PM10)',
      'Nitrogen dioxide (NO2)', 
      'Ozone (O3)',
      'Sulphur dioxide (SO2)',
      'Nitric oxide (NO)',
      'Nitrogen oxides as nitrogen dioxide (NOx as NO2)',
      'Carbon monoxide (CO)',
      // Additional variations for better matching
      'Particulate matter (PM2.5)',
      'PM2.5',
      'PM10', 
      'Nitrogen dioxide',
      'NO2',
      'Ozone',
      'O3',
      'Sulphur dioxide',
      'SO2',
      'Nitric oxide',
      'NO',
      'Nitrogen oxides as nitrogen dioxide',
      'NOx as NO2',
      'Carbon monoxide',
      'CO'
    ];
    
    const lowerValue = (value || '').toLowerCase().trim();
    return allowedPollutants.some(pollutant => 
      pollutant.toLowerCase().trim() === lowerValue
    );
  }

  // 2) Add new pollutant with duplicate check (specific mode)
  addButton.addEventListener('click', function (e) {
    e.preventDefault();

    // Wait for autocomplete input to be ready if not immediately available
    const getInput = () => {
      const input = document.querySelector('#my-autocomplete');
      if (input) return input;
      
      // If input doesn't exist yet, wait a short time for autocomplete to initialize
      return new Promise(resolve => {
        const checkInterval = setInterval(() => {
          const input = document.querySelector('#my-autocomplete');
          if (input) {
            clearInterval(checkInterval);
            resolve(input);
          }
        }, 50); // Check every 50ms
        
        // Timeout after 2 seconds
        setTimeout(() => {
          clearInterval(checkInterval);
          resolve(null);
        }, 2000);
      });
    };

    // Get input (either immediately or wait for it)
    Promise.resolve(getInput()).then(input => {
      if (!input) {
        console.error('Autocomplete input not found');
        showInlineError('Unable to access pollutant input field', { errorId: 'pollutant-error', inputSelector: '#autocomplete-container-p' });
        return;
      }

      console.log("my-autocomplete", input.value);

      const value = (input.value || '').trim();
      if (!value) {
        showInlineError('Enter a pollutant', { errorId: 'pollutant-error', inputSelector: '#my-autocomplete' });
        showErrorSummary([{ text: 'Enter a pollutant', href: '#my-autocomplete' }]); // NEW
        return;
      }
if (!isAllowed(value)) {
        showInlineError('Select a pollutant from the list', { errorId: 'pollutant-error', inputSelector: '#my-autocomplete' });
        showErrorSummary([{ text: 'Select a pollutant from the list', href: '#my-autocomplete' }]); // NEW
        return;
      }

      const lowerValue = value.toLowerCase();
      if (addedPollutants.has(lowerValue)) {
        const errorSummary = document.getElementById('duplicate-error');
        if (errorSummary) {
          errorSummary.hidden = false;
          errorSummary.focus();
          errorSummary.scrollIntoView({ behavior: 'smooth' });
        }
        return;
      }

      // OPTIONAL: enforce max 5 for specific mode (uncomment to strictly cap)
      // if (tableBody.children.length >= 5) {
      //   alert('You can add up to 5 pollutants.');
      //   return;
      // }

      clearInlineError({ inputSelector: '#my-autocomplete' });
      clearErrorSummary();
      count++;
      addedPollutants.add(lowerValue);

      if (table.hidden) table.hidden = false;

      const row = document.createElement('tr');
      row.className = 'govuk-table__row';

      const headerCell = document.createElement('th');
      headerCell.scope = 'row';
      headerCell.className = 'govuk-table__header';
      headerCell.textContent = `Pollutant ${count}`;

      const valueCell = document.createElement('td');
      valueCell.className = 'govuk-table__cell';
      valueCell.textContent = value;

      const actionCell = document.createElement('td');
      actionCell.className = 'govuk-table__cell';

      const removeLink = document.createElement('a');
      removeLink.href = '#';
      removeLink.className = 'govuk-link';
      removeLink.textContent = 'Remove';

      removeLink.addEventListener('click', function (e) {
        e.preventDefault();
        row.remove();
        addedPollutants.delete(lowerValue);

        // Update row numbers after removal
        updateRowNumbers();

        // Persist updated table-only list
        persistSpecificFromTable();

        if (tableBody.children.length === 0) {
          table.hidden = true;
          count = 0;
        }
        updateAddButtonText();
      });

      actionCell.appendChild(removeLink);
      row.appendChild(headerCell);
      row.appendChild(valueCell);
      row.appendChild(actionCell);
      tableBody.appendChild(row);

      input.value = '';

      const errorSummary = document.getElementById('duplicate-error');
      if (errorSummary) errorSummary.hidden = true;

      // Persist updated table-only list
      persistSpecificFromTable();

      updateAddButtonText();
    });
  });

 

  // Ensure radios start unchecked unless we have a prior selection in sessionStorage
(function setInitialModeFromSession() {
  // Start fully unchecked
  document.querySelectorAll('input[name="pollutant-mode"]').forEach(r => (r.checked = false));
  document.querySelectorAll('input[name="pollutant-group"]').forEach(r => (r.checked = false));

  // Decide mode from stored state:
  // - If a group key exists â†’ group mode
  // - Else if we have any specific list (table-only or selected) â†’ specific mode
  const hasGroup = !!sessionStorage.getItem('selectedPollutantGroup');
  const specificList = (function () {
    try { return JSON.parse(sessionStorage.getItem('selectedPollutantsSpecific') || '[]'); } catch { return []; }
  })();
  const selectedList = (function () {
    try { return JSON.parse(sessionStorage.getItem('selectedPollutants') || '[]'); } catch { return []; }
  })();

  const hasSpecific = Array.isArray(specificList) && specificList.length > 0;
  const hasAnySelected = Array.isArray(selectedList) && selectedList.length > 0;

  // First-time visit: nothing selected anywhere â†’ leave both radios unchecked
  if (!hasGroup && !hasSpecific && !hasAnySelected) return;

  // Pre-select the appropriate mode and reveal its conditional via GOV.UK Radios change event
  const modeId = hasGroup ? 'mode-group' : 'mode-specific';
  const modeEl = document.getElementById(modeId);
  if (modeEl) {
    modeEl.checked = true;
    modeEl.dispatchEvent(new Event('change', { bubbles: true }));
  }

  // If returning with a group, also re-select the specific group radio
  if (hasGroup) {
    const key = sessionStorage.getItem('selectedPollutantGroup'); // e.g. "core", "hydrocarbon", etc.
    const groupEl = document.querySelector(`input[name="pollutant-group"][value="${key}"]`);
    if (groupEl) {
      groupEl.checked = true;
      groupEl.dispatchEvent(new Event('change', { bubbles: true }));
    }
  }
})();


  // 3) Continue: save and redirect (handles both modes)
  continueButton.addEventListener('click', function (e) {
    e.preventDefault();
     

    const selectedMode = document.querySelector('input[name="pollutant-mode"]:checked')?.value;
     if (!selectedMode) {
        // ensure any previous inline on the fieldset is removed, just in case
        clearInlineError({ containerSelector: '#mode-fieldset', inputSelector: '#mode-specific' });
        showErrorSummary([{ text: 'Please select an option before continuing', href: '#mode-specific' }]);
        return;
      } else {
        clearErrorSummary();
      }

    if (selectedMode === 'group') {
      const chosen = document.querySelector('input[name="pollutant-group"]:checked');
      if (!chosen) {
          // NEW: inline error targeted to the group conditional, plus summary
          showInlineError('Select a pollutant group', {
            containerSelector: '#pollutant-group-form-group',
            inputSelector: '#pg-core',
            errorId: 'pollutant-group-error'
          });
          showErrorSummary([{ text: 'Select a pollutant group', href: '#pg-core' }]);
          return;
        } else {
          clearInlineError({ containerSelector: '#pollutant-group-form-group', inputSelector: '#pg-core' });
          clearErrorSummary();
        }


      const key = chosen.value;
      const list = GROUPS[key] || [];

      // Keep downstream behaviour the same:
      //  - selectedPollutants = full expanded group list
      //  - selectedPollutantGroup = chosen key
      //  - specific table list is cleared so it won't re-populate the table next time
      writeJSON(KEY_SELECTED, list);
      sessionStorage.setItem(KEY_GROUP, key);
      writeJSON(KEY_SPECIFIC, []); // <<< important

      // Reset any previous data source selection
      sessionStorage.removeItem('selectedDataSources');

      const hash = JSON.stringify(list.map(s => (s || '').toLowerCase().trim()).sort());
      sessionStorage.setItem('dsPollutantHash', hash);

      window.location.href = `/customdataset/${key}`;
      return;
    }

    // default/specific mode
    let pollutants = [];

    if (table && !table.hidden && tableBody && tableBody.children.length > 0) {
  const rows = tableBody.querySelectorAll('tr');
  rows.forEach(row => {
    const name = row.querySelector('td')?.textContent?.trim();
    if (name) pollutants.push(name);
  });
} else {
  const input = document.querySelector('#my-autocomplete');
  const value = (input && input.value.trim()) || '';
  if (value) {
    if (!isAllowed(value)) {
      showInlineError('Select a pollutant from the list', { errorId: 'pollutant-error', inputSelector: '#my-autocomplete' });
      showErrorSummary([{ text: 'Select a pollutant from the list', href: '#my-autocomplete' }]);
      return;
    }
    pollutants.push(value);
  }
}

/* NEW: block continue when mode=specific and no pollutants provided at all */
if (!pollutants.length) {
  showInlineError('Enter a pollutant', {
    containerSelector: '#pollutant-form-group',
    inputSelector: '#my-autocomplete',
    errorId: 'pollutant-error'
  });
  showErrorSummary([{ text: 'Enter a pollutant', href: '#my-autocomplete' }]);
  return;
}

    // Persist both:
    //  - selectedPollutants = whatever is in the table (for downstream pages)
    //  - selectedPollutantsSpecific = same list (so the table restores correctly)
    writeJSON(KEY_SELECTED, pollutants);
    writeJSON(KEY_SPECIFIC, pollutants);

    // Weâ€™re no longer using a group
    sessionStorage.removeItem(KEY_GROUP);

    sessionStorage.removeItem('selectedDataSources');

    const hash = JSON.stringify(pollutants.map(s => (s || '').toLowerCase().trim()).sort());
    sessionStorage.setItem('dsPollutantHash', hash);
      const input1 = document.querySelector('#my-autocomplete');
console.log("customdataset", input1.value);
if (!pollutants || pollutants.length === 0) {
   window.location.href = `/customdataset/${encodeURIComponent(null)}`;
}
else{

    window.location.href = `/customdataset/${encodeURIComponent(pollutants)}`;
}
  });
});
</script>

{% endblock %}